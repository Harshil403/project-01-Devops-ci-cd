name: Local CI-CD Todo App

on:
  push:
    branches:
      - main

jobs:
  build-push-deploy:
    runs-on: self-hosted   # üî• local system runner

    steps:
    # 1Ô∏è‚É£ Checkout code
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: GitGuardian Scan
      uses: gitguardian/ggshield-action@v1
      with:
        mode: ci
      env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base_ref }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}


    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
    
    - name: Install Backend Dependencies
      run: pip install -r requirements.txt
      working-directory: backend
    
    - name: Snyk Backend Dependency Scan (Python)
      run: npx snyk test --severity-threshold=high
      working-directory: backend
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}



    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "18"
    - name: Install Frontend Dependencies
      run: npm install
      working-directory: frontend
    - name: Snyk Frontend Dependency Scan (React)
      run: npx snyk test --severity-threshold=high
      working-directory: frontend
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}





      
#    - name: Run Gitleaks 
#      run: |
#        docker run --rm \
#          -v $PWD:/repo \
#          zricethezav/gitleaks:latest detect \
#          --source=/repo \
#          --no-git \
#          --verbose \
#          --redact \
#          --exit-code 1
      

    # 2Ô∏è‚É£ Login to Docker Hub
    - name: Login to Docker Hub
      run: |
        echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
        -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    # 3Ô∏è‚É£ Build Backend Image
    - name: Build Backend Image
      run: |
        docker build \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/todo-backend:latest \
          -f backend/Dockerfile backend/

    # 4Ô∏è‚É£ Build Frontend Image
    - name: Build Frontend Image
      run: |
        docker build \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/todo-frontend:latest \
          -f frontend/Dockerfile frontend/

    # 5Ô∏è‚É£ Build Nginx Image
    - name: Build Nginx Image
      run: |
        docker build \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/todo-nginx:latest \
          -f nginx/Dockerfile nginx/

    # 6Ô∏è‚É£ Push Images
    - name: Push Docker Images
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/todo-backend:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/todo-frontend:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/todo-nginx:latest

    # 7Ô∏è‚É£ Deploy to Local Kubernetes
    - name: Deploy to Local Kubernetes
      run: |
        
        kubectl apply -f k8/postgres-secret.yaml
        kubectl apply -f k8/postgres-pvc.yaml
        kubectl apply -f k8/postgres.yaml
    
        kubectl apply -f k8/nginx-config.yaml
    
        kubectl apply -f k8/backend.yaml
        kubectl apply -f k8/frontend.yaml
        kubectl apply -f k8/nginx.yaml

    # 8Ô∏è‚É£ Verify Deployment
    - name: Verify Deployment
      run: |
        kubectl get pods
        kubectl get svc
